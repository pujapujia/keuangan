<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keuangan</title>
    <style>
        /* CSS tetap sama, tambah styling untuk saldo input */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #000000;
            color: #ffffff;
        }
        h1 {
            text-align: center;
            color: #FFD700;
        }
        .nav {
            text-align: center;
            margin-bottom: 20px;
        }
        .nav button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #FF0000;
            color: #ffffff;
            font-size: 1em;
        }
        .nav button.active {
            background-color: #FFD700;
            color: #000000;
        }
        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .card {
            background: #ffffff;
            border: 2px solid #FF0000;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(255, 0, 0, 0.3);
            padding: 20px;
            color: #000000;
        }
        .card h2 {
            color: #000000;
            font-weight: bold;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        th, td {
            border: 1px solid #FF0000;
            padding: 8px;
            text-align: left;
            cursor: pointer;
        }
        th {
            background-color: #FFD700;
            color: #000000;
        }
        td:hover {
            background-color: #FF0000;
            color: #ffffff;
        }
        .total {
            font-weight: bold;
            margin-top: 10px;
            color: #000000;
        }
        .total span {
            color: #000000;
        }
        .year-total {
            text-align: center;
            margin: 20px 0;
            font-size: 1.2em;
            font-weight: bold;
            color: #FFD700;
        }
        .saldo-container {
            margin-bottom: 20px;
            background: #ffffff;
            padding: 10px;
            border: 2px solid #FF0000;
            border-radius: 5px;
            color: #000000;
            width: fit-content;
        }
        .saldo-container label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        .saldo-container input {
            padding: 5px;
            border: 1px solid #FF0000;
            border-radius: 5px;
            width: 150px;
            margin-right: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #ffffff;
            padding: 20px;
            border: 2px solid #FF0000;
            border-radius: 5px;
            width: 90%;
            max-width: 400px;
            color: #000000;
        }
        .modal-content input, .modal-content select {
            width: 100%;
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #FF0000;
            box-sizing: border-box;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .save-btn {
            background-color: #FF0000;
            color: #ffffff;
        }
        .cancel-btn {
            background-color: #FFD700;
            color: #000000;
        }
        .delete-btn {
            background-color: #000000;
            color: #ffffff;
        }
        .add-btn {
            background-color: #FF0000;
            color: #ffffff;
            display: block;
            margin: 10px auto;
        }
        .download-btn {
            background-color: #FFD700;
            color: #000000;
            margin: 10px auto;
            display: block;
        }
        .empty-message {
            text-align: center;
            color: #FF0000;
            margin: 10px 0;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .login-page, .roadmap-page {
            max-width: 400px;
            margin: 50px auto;
            background: #ffffff;
            padding: 20px;
            border: 2px solid #FF0000;
            border-radius: 8px;
            color: #000000;
        }
        .roadmap-container {
            padding: 20px;
        }
        .roadmap-item {
            margin: 10px 0;
            padding: 10px;
            background: #ffffff;
            border: 1px solid #FF0000;
            border-radius: 5px;
            color: #000000;
            cursor: pointer;
        }
        .roadmap-item h3 {
            color: #000000;
            font-weight: bold;
        }
        .year-selector {
            text-align: center;
            margin: 10px 0;
        }
        .year-selector select {
            padding: 5px;
            border: 1px solid #FF0000;
            border-radius: 5px;
            background: #ffffff;
            color: #000000;
        }
        @media (max-width: 600px) {
            .container {
                grid-template-columns: 1fr;
            }
            .saldo-container {
                width: 100%;
            }
            .saldo-container input {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <!-- Halaman Login -->
    <div id="loginPage" class="login-page">
        <h2 style="color: #000000; text-align: center;">Login</h2>
        <input type="text" id="username" placeholder="Username (Email)">
        <input type="password" id="password" placeholder="Password">
        <button class="save-btn" onclick="login()">Login</button>
    </div>

    <!-- Halaman Utama -->
    <div id="mainPage" style="display: none;">
        <h1>Keuangan <span id="currentYear">2025</span></h1>
        <div class="year-selector">
            <select id="yearSelect" onchange="changeYear()">
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
                <option value="2029">2029</option>
                <option value="2030">2030</option>
            </select>
        </div>
        <div class="nav">
            <button id="pemasukanBtn" class="active" onclick="showPage('pemasukan')">PEMASUKAN</button>
            <button id="pengeluaranBtn" onclick="showPage('pengeluaran')">PENGELUARAN</button>
            <button id="roadmapBtn" onclick="showPage('roadmap')">ROADMAP</button>
        </div>

        <!-- Halaman Pemasukan -->
        <div id="pemasukanPage" class="page active">
            <div class="container" id="pemasukanContainer"></div>
            <div class="year-total">Total Pemasukan Tahun <span id="pemasukanYear">2025</span>: <span id="pemasukanYearTotal">Rp0</span></div>
            <button class="download-btn" onclick="openDownloadModal('pemasukan')">Download PDF</button>
        </div>

        <!-- Halaman Pengeluaran -->
        <div id="pengeluaranPage" class="page">
            <div class="saldo-container">
                <label>Saldo Awal Cash:</label>
                <input type="number" id="saldoCash" min="0" onchange="updateSaldo('cash')">
                <br>
                <label>Saldo Awal Crypto:</label>
                <input type="number" id="saldoCrypto" min="0" onchange="updateSaldo('crypto')">
            </div>
            <div class="container" id="pengeluaranContainer"></div>
            <div class="year-total">
                Total Pengeluaran Cash Tahun <span id="pengeluaranYear">2025</span>: <span id="pengeluaranYearTotalCash">Rp0</span><br>
                Total Pengeluaran Crypto Tahun <span id="pengeluaranYearTotalCrypto">Rp0</span>
            </div>
            <button class="download-btn" onclick="openDownloadModal('pengeluaran')">Download PDF</button>
        </div>

        <!-- Halaman Roadmap -->
        <div id="roadmapPage" class="page">
            <div class="roadmap-container" id="roadmapContainer"></div>
            <button class="add-btn" onclick="openRoadmapModal()">Tambah Rencana</button>
        </div>
    </div>

    <!-- Modal untuk Edit/Tambah Data -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3 id="modalTitle">Edit Data</h3>
            <input type="text" id="editField1" placeholder="Nama/Kategori">
            <input type="number" id="editTanggal" placeholder="Tanggal" min="1" max="31">
            <select id="editTipe" style="display: none;">
                <option value="Cash">Cash</option>
                <option value="Crypto">Crypto</option>
            </select>
            <input type="number" id="editField2" placeholder="Pemasukan/Jumlah (Rp)">
            <button class="save-btn" onclick="saveEdit()">Simpan</button>
            <button class="delete-btn" id="deleteBtn" onclick="deleteEntry()">Hapus</button>
            <button class="cancel-btn" onclick="closeModal()">Batal</button>
        </div>
    </div>

    <!-- Modal untuk Download PDF -->
    <div class="modal" id="downloadModal">
        <div class="modal-content">
            <h3>Pilih Bulan untuk Download</h3>
            <select id="downloadMonth" multiple>
                <option value="all">Semua Bulan</option>
                <option value="Januari">Januari</option>
                <option value="Februari">Februari</option>
                <option value="Maret">Maret</option>
                <option value="April">April</option>
                <option value="Mei">Mei</option>
                <option value="Juni">Juni</option>
                <option value="Juli">Juli</option>
                <option value="Agustus">Agustus</option>
                <option value="September">September</option>
                <option value="Oktober">Oktober</option>
                <option value="November">November</option>
                <option value="Desember">Desember</option>
            </select>
            <button class="save-btn" onclick="downloadPDF()">Download</button>
            <button class="cancel-btn" onclick="closeDownloadModal()">Batal</button>
        </div>
    </div>

    <!-- Modal untuk Tambah/Edit Roadmap -->
    <div class="modal" id="roadmapModal">
        <div class="modal-content">
            <h3>Tambah/Edit Rencana</h3>
            <select id="roadmapMonth">
                <option value="Januari">Januari</option>
                <option value="Februari">Februari</option>
                <option value="Maret">Maret</option>
                <option value="April">April</option>
                <option value="Mei">Mei</option>
                <option value="Juni">Juni</option>
                <option value="Juli">Juli</option>
                <option value="Agustus">Agustus</option>
                <option value="September">September</option>
                <option value="Oktober">Oktober</option>
                <option value="November">November</option>
                <option value="Desember">Desember</option>
            </select>
            <input type="text" id="roadmapPlan" placeholder="Rencana (contoh: Beli mobil)">
            <button class="save-btn" onclick="saveRoadmap()">Simpan</button>
            <button class="delete-btn" id="roadmapDeleteBtn" onclick="deleteRoadmap()">Hapus</button>
            <button class="cancel-btn" onclick="closeRoadmapModal()">Batal</button>
        </div>
    </div>

    <script>
        // Firebase konfigurasi (ganti dengan config Anda)
        const firebaseConfig = {
            apiKey: "AIzaSyBITs7xek4i4PRZKAWYzAh6EEsTEPqn6V8",
            authDomain: "keuangan-e147f.firebaseapp.com",
            databaseURL: "https://keuangan-e147f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "keuangan-e147f",
            storageBucket: "keuangan-e147f.firebasestorage.app",
            messagingSenderId: "878121948921",
            appId: "1:878121948921:web:2e1bcd87a7910e1592b428"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Data dan state
        const months = [
            'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
            'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
        ];
        let pemasukanData = {};
        let pengeluaranData = {};
        let saldoAwalData = {};
        let roadmapData = {};
        let currentYear = '2025';
        let currentUser = null;
        let currentRow = null;
        let currentMonth = null;
        let currentIndex = null;
        let isAdding = false;
        let currentPage = 'pemasukan';
        let currentRoadmapIndex = null;

        // Cek status login saat halaman dimuat
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainPage').style.display = 'block';
                initializeData(currentYear);
                loadData();
            } else {
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('mainPage').style.display = 'none';
            }
        });

        // Inisialisasi data untuk tahun tertentu
        function initializeData(year) {
            if (!pemasukanData[year]) {
                pemasukanData[year] = months.reduce((acc, month) => {
                    acc[month] = [];
                    return acc;
                }, {});
            }
            if (!pengeluaranData[year]) {
                pengeluaranData[year] = months.reduce((acc, month) => {
                    acc[month] = [];
                    return acc;
                }, {});
            }
            if (!saldoAwalData[year]) {
                saldoAwalData[year] = { cash: 0, crypto: 0 };
            }
            if (!roadmapData[year]) {
                roadmapData[year] = months.reduce((acc, month) => {
                    acc[month] = [];
                    return acc;
                }, {});
            }
        }

        // Login
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(username, password)
                .then(userCredential => {
                    currentUser = userCredential.user;
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('mainPage').style.display = 'block';
                    initializeData(currentYear);
                    loadData();
                })
                .catch(error => {
                    alert('Login gagal: ' + error.message);
                });
        }

        // Load data dari Firebase
        function loadData() {
            if (!currentUser) return;
            db.ref(`users/${currentUser.uid}/data/${currentYear}`).once('value', snapshot => {
                const data = snapshot.val() || {};
                pemasukanData[currentYear] = data.pemasukan || months.reduce((acc, month) => {
                    acc[month] = [];
                    return acc;
                }, {});
                pengeluaranData[currentYear] = data.pengeluaran || months.reduce((acc, month) => {
                    acc[month] = [];
                    return acc;
                }, {});
                saldoAwalData[currentYear] = data.saldoAwal || { cash: 0, crypto: 0 };
                roadmapData[currentYear] = data.roadmap || months.reduce((acc, month) => {
                    acc[month] = [];
                    return acc;
                }, {});
                updateSaldoDisplay();
                if (currentPage === 'pemasukan') renderPemasukanCards();
                else if (currentPage === 'pengeluaran') renderPengeluaranCards();
                else renderRoadmap();
            }).catch(error => {
                console.error('Error loading data:', error);
                alert('Gagal memuat data dari Firebase. Periksa koneksi atau konfigurasi.');
            });
        }

        // Simpan data ke Firebase
        function saveData() {
            if (currentUser) {
                db.ref(`users/${currentUser.uid}/data/${currentYear}`).set({
                    pemasukan: pemasukanData[currentYear],
                    pengeluaran: pengeluaranData[currentYear],
                    saldoAwal: saldoAwalData[currentYear],
                    roadmap: roadmapData[currentYear]
                }).catch(error => {
                    console.error('Error saving data:', error);
                    alert('Gagal menyimpan data ke Firebase.');
                });
            }
        }

        // Update display saldo
        function updateSaldoDisplay() {
            document.getElementById('saldoCash').value = saldoAwalData[currentYear].cash || 0;
            document.getElementById('saldoCrypto').value = saldoAwalData[currentYear].crypto || 0;
        }

        // Update saldo saat input diubah
        function updateSaldo(type) {
            const value = parseInt(document.getElementById(`saldo${type.charAt(0).toUpperCase() + type.slice(1)}`).value) || 0;
            if (value >= 0) {
                saldoAwalData[currentYear][type] = value;
                saveData();
            } else {
                alert('Saldo tidak boleh negatif!');
                updateSaldoDisplay();
            }
        }

        // Ganti tahun
        function changeYear() {
            currentYear = document.getElementById('yearSelect').value;
            document.getElementById('currentYear').textContent = currentYear;
            document.getElementById('pemasukanYear').textContent = currentYear;
            document.getElementById('pengeluaranYear').textContent = currentYear;
            initializeData(currentYear);
            loadData();
        }

        // Navigasi halaman
        function showPage(page) {
            currentPage = page;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`${page}Page`).classList.add('active');
            document.querySelectorAll('.nav button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${page}Btn`).classList.add('active');
            if (page === 'pemasukan') renderPemasukanCards();
            else if (page === 'pengeluaran') renderPengeluaranCards();
            else renderRoadmap();
        }

        // Hitung total berdasarkan tipe
        function calculateTotal(monthData, type, tipe = null) {
            if (type === 'pemasukan') {
                return monthData.reduce((sum, item) => sum + item.pemasukan, 0);
            } else {
                return monthData.reduce((sum, item) => {
                    if (tipe && item.tipe !== tipe) return sum;
                    return sum + item.jumlah;
                }, 0);
            }
        }

        // Render kartu untuk Pemasukan
        function renderPemasukanCards() {
            const container = document.getElementById('pemasukanContainer');
            container.innerHTML = '';
            months.forEach(month => {
                const monthData = pemasukanData[currentYear][month] || [];
                const card = document.createElement('div');
                card.className = 'card';
                card.id = `pemasukan-${month.toLowerCase()}`;
                const tableContent = monthData.length > 0
                    ? monthData.map((item, index) => `
                        <tr data-month="${month}" data-index="${index}">
                            <td>${item.nama}</td>
                            <td>${item.tanggal}</td>
                            <td>Rp${item.pemasukan.toLocaleString('id-ID')}</td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="3" class="empty-message">Belum ada data</td></tr>';
                card.innerHTML = `
                    <h2>${month.toUpperCase()}</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Nama</th>
                                <th>Tanggal</th>
                                <th>Pemasukan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableContent}
                        </tbody>
                    </table>
                    <div class="total">Total: <span>Rp${calculateTotal(monthData, 'pemasukan').toLocaleString('id-ID')}</span></div>
                    <button class="add-btn" onclick="openAddModal('${month}', 'pemasukan')">Tambah Data</button>
                `;
                container.appendChild(card);
            });

            document.querySelectorAll('#pemasukanContainer tbody tr:not(.empty-message)').forEach(row => {
                row.addEventListener('click', () => {
                    currentRow = row;
                    currentMonth = row.dataset.month;
                    currentIndex = row.dataset.index;
                    openModal(row, false, 'pemasukan');
                });
            });

            updatePemasukanYearTotal();
        }

        // Render kartu untuk Pengeluaran
        function renderPengeluaranCards() {
            const container = document.getElementById('pengeluaranContainer');
            container.innerHTML = '';
            months.forEach(month => {
                const monthData = pengeluaranData[currentYear][month] || [];
                const card = document.createElement('div');
                card.className = 'card';
                card.id = `pengeluaran-${month.toLowerCase()}`;
                const tableContent = monthData.length > 0
                    ? monthData.map((item, index) => `
                        <tr data-month="${month}" data-index="${index}">
                            <td>${item.kategori}</td>
                            <td>${item.tanggal}</td>
                            <td>${item.tipe}</td>
                            <td>Rp${item.jumlah.toLocaleString('id-ID')}</td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="4" class="empty-message">Belum ada pengeluaran</td></tr>';
                const totalCash = calculateTotal(monthData, 'pengeluaran', 'Cash');
                const totalCrypto = calculateTotal(monthData, 'pengeluaran', 'Crypto');
                card.innerHTML = `
                    <h2>${month.toUpperCase()}</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Kategori</th>
                                <th>Tanggal</th>
                                <th>Tipe</th>
                                <th>Jumlah</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableContent}
                        </tbody>
                    </table>
                    <div class="total">Total Pengeluaran Cash: <span>Rp${totalCash.toLocaleString('id-ID')}</span></div>
                    <div class="total">Total Pengeluaran Crypto: <span>Rp${totalCrypto.toLocaleString('id-ID')}</span></div>
                    <button class="add-btn" onclick="openAddModal('${month}', 'pengeluaran')">Tambah Pengeluaran</button>
                `;
                container.appendChild(card);
            });

            document.querySelectorAll('#pengeluaranContainer tbody tr:not(.empty-message)').forEach(row => {
                row.addEventListener('click', () => {
                    currentRow = row;
                    currentMonth = row.dataset.month;
                    currentIndex = row.dataset.index;
                    openModal(row, false, 'pengeluaran');
                });
            });

            updatePengeluaranYearTotal();
            updateSaldoDisplay();
        }

        // Render Roadmap
        function renderRoadmap() {
            const container = document.getElementById('roadmapContainer');
            container.innerHTML = '';
            months.forEach(month => {
                const plans = roadmapData[currentYear][month] || [];
                const planContent = plans.length > 0
                    ? plans.map((plan, index) => `
                        <div class="roadmap-item" data-month="${month}" data-index="${index}">
                            <h3>${month} ${currentYear}</h3>
                            <p>${plan.plan}</p>
                        </div>
                    `).join('')
                    : `<div class="roadmap-item"><p class="empty-message">Belum ada rencana untuk ${month}</p></div>`;
                container.innerHTML += planContent;
            });

            document.querySelectorAll('.roadmap-item:not(.empty-message)').forEach(item => {
                item.addEventListener('click', () => {
                    currentMonth = item.dataset.month;
                    currentRoadmapIndex = item.dataset.index;
                    openRoadmapModal(item);
                });
            });
        }

        // Update total tahunan
        function updatePemasukanYearTotal() {
            const yearTotal = months.reduce((sum, month) => sum + calculateTotal(pemasukanData[currentYear][month] || [], 'pemasukan'), 0);
            document.getElementById('pemasukanYearTotal').textContent = `Rp${yearTotal.toLocaleString('id-ID')}`;
        }

        function updatePengeluaranYearTotal() {
            const yearTotalCash = months.reduce((sum, month) => sum + calculateTotal(pengeluaranData[currentYear][month] || [], 'pengeluaran', 'Cash'), 0);
            const yearTotalCrypto = months.reduce((sum, month) => sum + calculateTotal(pengeluaranData[currentYear][month] || [], 'pengeluaran', 'Crypto'), 0);
            document.getElementById('pengeluaranYearTotalCash').textContent = `Rp${yearTotalCash.toLocaleString('id-ID')}`;
            document.getElementById('pengeluaranYearTotalCrypto').textContent = `Rp${yearTotalCrypto.toLocaleString('id-ID')}`;
        }

        // Modal untuk edit atau tambah data
        function openModal(row, isAdd, page) {
            isAdding = isAdd;
            currentPage = page;
            document.getElementById('modalTitle').textContent = isAdd 
                ? (page === 'pemasukan' ? 'Tambah Data' : 'Tambah Pengeluaran') 
                : (page === 'pemasukan' ? 'Edit Data' : 'Edit Pengeluaran');
            document.getElementById('deleteBtn').style.display = isAdd ? 'none' : 'inline-block';
            document.getElementById('editField1').placeholder = page === 'pemasukan' ? 'Nama' : 'Kategori';
            document.getElementById('editField2').placeholder = page === 'pemasukan' ? 'Pemasukan (Rp)' : 'Jumlah (Rp)';
            document.getElementById('editTipe').style.display = page === 'pengeluaran' ? 'block' : 'none';
            if (isAdd) {
                document.getElementById('editField1').value = '';
                document.getElementById('editTanggal').value = '';
                document.getElementById('editField2').value = '';
                document.getElementById('editTipe').value = 'Cash';
            } else {
                const field1 = row.cells[0].textContent;
                const tanggal = row.cells[1].textContent;
                const field2 = parseInt(row.cells[page === 'pemasukan' ? 2 : 3].textContent.replace('Rp', '').replace(/\./g, ''));
                document.getElementById('editField1').value = field1;
                document.getElementById('editTanggal').value = tanggal;
                document.getElementById('editField2').value = field2;
                if (page === 'pengeluaran') {
                    document.getElementById('editTipe').value = row.cells[2].textContent;
                }
            }
            document.getElementById('editModal').style.display = 'flex';
        }

        function openAddModal(month, page) {
            currentMonth = month;
            openModal(null, true, page);
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function saveEdit() {
            const field1 = document.getElementById('editField1').value.trim();
            const tanggal = parseInt(document.getElementById('editTanggal').value);
            const field2 = parseInt(document.getElementById('editField2').value);
            const tipe = document.getElementById('editTipe').value;

            if (field1 && tanggal >= 1 && tanggal <= 31 && field2 > 0) {
                const data = currentPage === 'pemasukan' ? pemasukanData[currentYear] : pengeluaranData[currentYear];
                let oldAmount = 0;
                let oldTipe = null;

                if (!isAdding) {
                    oldAmount = data[currentMonth][currentIndex].jumlah || 0;
                    oldTipe = data[currentMonth][currentIndex].tipe;
                }

                const newEntry = currentPage === 'pemasukan' 
                    ? { nama: field1, tanggal, pemasukan: field2 }
                    : { kategori: field1, tanggal, tipe, jumlah: field2 };

                if (currentPage === 'pengeluaran') {
                    if (isAdding) {
                        if (tipe === 'Cash') {
                            if (saldoAwalData[currentYear].cash >= field2) {
                                saldoAwalData[currentYear].cash -= field2;
                            } else {
                                alert('Saldo Cash tidak cukup!');
                                return;
                            }
                        } else {
                            if (saldoAwalData[currentYear].crypto >= field2) {
                                saldoAwalData[currentYear].crypto -= field2;
                            } else {
                                alert('Saldo Crypto tidak cukup!');
                                return;
                            }
                        }
                    } else {
                        // Kembalikan saldo lama
                        if (oldTipe === 'Cash') {
                            saldoAwalData[currentYear].cash += oldAmount;
                        } else {
                            saldoAwalData[currentYear].crypto += oldAmount;
                        }
                        // Kurangi saldo baru
                        if (tipe === 'Cash') {
                            if (saldoAwalData[currentYear].cash >= field2) {
                                saldoAwalData[currentYear].cash -= field2;
                            } else {
                                alert('Saldo Cash tidak cukup!');
                                return;
                            }
                        } else {
                            if (saldoAwalData[currentYear].crypto >= field2) {
                                saldoAwalData[currentYear].crypto -= field2;
                            } else {
                                alert('Saldo Crypto tidak cukup!');
                                return;
                            }
                        }
                    }
                }

                if (isAdding) {
                    data[currentMonth].push(newEntry);
                } else {
                    data[currentMonth][currentIndex] = newEntry;
                }

                if (currentPage === 'pemasukan') renderPemasukanCards();
                else renderPengeluaranCards();
                saveData();
                closeModal();
            } else {
                alert('Isi semua kolom dengan data yang valid!');
            }
        }

        function deleteEntry() {
            if (confirm('Yakin ingin menghapus data ini?')) {
                const data = currentPage === 'pemasukan' ? pemasukanData[currentYear] : pengeluaranData[currentYear];
                if (currentPage === 'pengeluaran') {
                    const entry = data[currentMonth][currentIndex];
                    if (entry.tipe === 'Cash') {
                        saldoAwalData[currentYear].cash += entry.jumlah;
                    } else {
                        saldoAwalData[currentYear].crypto += entry.jumlah;
                    }
                }
                data[currentMonth].splice(currentIndex, 1);
                if (currentPage === 'pemasukan') renderPemasukanCards();
                else renderPengeluaranCards();
                saveData();
                closeModal();
            }
        }

        // Modal untuk download PDF
        function openDownloadModal(page) {
            currentPage = page;
            document.getElementById('downloadModal').style.display = 'flex';
        }

        function closeDownloadModal() {
            document.getElementById('downloadModal').style.display = 'none';
        }

        function downloadPDF() {
            const selectedMonths = Array.from(document.getElementById('downloadMonth').selectedOptions).map(option => option.value);
            const data = currentPage === 'pemasukan' ? pemasukanData[currentYear] : pengeluaranData[currentYear];
            const isPemasukan = currentPage === 'pemasukan';
            const monthsToDownload = selectedMonths.includes('all') ? months : selectedMonths;

            console.log('Generating PDF for:', currentPage, 'Months:', monthsToDownload);
            console.log('Data:', data);

            const element = document.createElement('div');
            element.style.padding = '20px';
            element.innerHTML = `<h1 style="color: #000000;">${isPemasukan ? 'Pemasukan' : 'Pengeluaran'} ${currentYear}</h1>`;

            if (!isPemasukan) {
                element.innerHTML += `
                    <p style="color: #000000;">Saldo Awal Cash: Rp${saldoAwalData[currentYear].cash.toLocaleString('id-ID')}</p>
                    <p style="color: #000000;">Saldo Awal Crypto: Rp${saldoAwalData[currentYear].crypto.toLocaleString('id-ID')}</p>
                `;
            }

            monthsToDownload.forEach(month => {
                const monthData = data[month] || [];
                console.log(`Month: ${month}, Data:`, monthData);

                const tableContent = monthData.length > 0
                    ? monthData.map(item => `
                        <tr>
                            <td style="border: 1px solid #FF0000; padding: 8px;">${isPemasukan ? item.nama : item.kategori}</td>
                            <td style="border: 1px solid #FF0000; padding: 8px;">${item.tanggal}</td>
                            ${!isPemasukan ? `<td style="border: 1px solid #FF0000; padding: 8px;">${item.tipe}</td>` : ''}
                            <td style="border: 1px solid #FF0000; padding: 8px;">Rp${(isPemasukan ? item.pemasukan : item.jumlah).toLocaleString('id-ID')}</td>
                        </tr>
                    `).join('')
                    : `<tr><td colspan="${isPemasukan ? 3 : 4}" style="color: #FF0000; text-align: center;">Belum ada data</td></tr>`;

                const totalCash = calculateTotal(monthData, 'pengeluaran', 'Cash');
                const totalCrypto = calculateTotal(monthData, 'pengeluaran', 'Crypto');
                const total = calculateTotal(monthData, isPemasukan ? 'pemasukan' : 'pengeluaran');
                const cardHtml = `
                    <div style="margin-bottom: 20px;">
                        <h2 style="color: #000000;">${month.toUpperCase()}</h2>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #FFD700;">
                                    <th style="border: 1px solid #FF0000; padding: 8px;">${isPemasukan ? 'Nama' : 'Kategori'}</th>
                                    <th style="border: 1px solid #FF0000; padding: 8px;">Tanggal</th>
                                    ${!isPemasukan ? `<th style="border: 1px solid #FF0000; padding: 8px;">Tipe</th>` : ''}
                                    <th style="border: 1px solid #FF0000; padding: 8px;">${isPemasukan ? 'Pemasukan' : 'Jumlah'}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableContent}
                            </tbody>
                        </table>
                        ${isPemasukan ? `
                            <p style="color: #000000; font-weight: bold;">Total: Rp${total.toLocaleString('id-ID')}</p>
                        ` : `
                            <p style="color: #000000; font-weight: bold;">Total Pengeluaran Cash: Rp${totalCash.toLocaleString('id-ID')}</p>
                            <p style="color: #000000; font-weight: bold;">Total Pengeluaran Crypto: Rp${totalCrypto.toLocaleString('id-ID')}</p>
                        `}
                    </div>
                `;
                element.innerHTML += cardHtml;
            });

            const opt = {
                margin: 1,
                filename: `${isPemasukan ? 'Pemasukan' : 'Pengeluaran'}_${currentYear}_${selectedMonths.includes('all') ? 'Semua' : selectedMonths.join('-')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().from(element).set(opt).save();
            closeDownloadModal();
        }

        // Modal untuk tambah/edit roadmap
        function openRoadmapModal(item = null) {
            currentRoadmapIndex = item ? item.dataset.index : null;
            document.getElementById('roadmapDeleteBtn').style.display = item ? 'inline-block' : 'none';
            if (item) {
                currentMonth = item.dataset.month;
                document.getElementById('roadmapMonth').value = currentMonth;
                document.getElementById('roadmapPlan').value = roadmapData[currentYear][currentMonth][currentRoadmapIndex].plan;
            } else {
                currentMonth = 'Januari';
                document.getElementById('roadmapMonth').value = 'Januari';
                document.getElementById('roadmapPlan').value = '';
            }
            document.getElementById('roadmapModal').style.display = 'flex';
        }

        function closeRoadmapModal() {
            document.getElementById('roadmapModal').style.display = 'none';
        }

        function saveRoadmap() {
            const month = document.getElementById('roadmapMonth').value;
            const plan = document.getElementById('roadmapPlan').value.trim();
            if (plan) {
                if (!roadmapData[currentYear][month]) {
                    roadmapData[currentYear][month] = [];
                }
                if (currentRoadmapIndex !== null) {
                    roadmapData[currentYear][month][currentRoadmapIndex] = { plan };
                } else {
                    roadmapData[currentYear][month].push({ plan });
                }
                renderRoadmap();
                saveData();
                closeRoadmapModal();
            } else {
                alert('Masukkan rencana!');
            }
        }

        function deleteRoadmap() {
            if (confirm('Yakin ingin menghapus rencana ini?')) {
                roadmapData[currentYear][currentMonth].splice(currentRoadmapIndex, 1);
                renderRoadmap();
                saveData();
                closeRoadmapModal();
            }
        }
    </script>
</body>
</html>